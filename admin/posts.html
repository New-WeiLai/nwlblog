<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章管理 - Nwely（陌筏）の 博客</title>
    <link rel="stylesheet" href="/css/admin.css">
    <style>
        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        .search-box input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e1e1;
            border-radius: 6px;
            font-size: 14px;
        }
        .filter-select {
            padding: 10px;
            border: 2px solid #e1e1e1;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .post-title-cell {
            max-width: 300px;
        }
        .post-title-cell a {
            color: #333;
            text-decoration: none;
            font-weight: 500;
        }
        .post-title-cell a:hover {
            color: #667eea;
        }
        .post-meta {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        .editor-modal {
            max-width: 800px;
        }
        .editor-toolbar {
            background: #f8f9fa;
            border: 1px solid #e1e1e1;
            border-radius: 6px 6px 0 0;
            padding: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .editor-toolbar button {
            padding: 6px 12px;
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .editor-toolbar button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .editor-content {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 1px solid #e1e1e1;
            border-top: none;
            border-radius: 0 0 6px 6px;
            font-family: monospace;
            resize: vertical;
        }
        .tag-input {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            border: 2px solid #e1e1e1;
            border-radius: 6px;
        }
        .tag {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
        }
        .tag-remove:hover {
            color: #ff4444;
        }
        .tag-input-field {
            border: none;
            outline: none;
            flex: 1;
            min-width: 100px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="/avatar.png" alt="Nwely" class="sidebar-logo">
                <h2>管理后台</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/dashboard.html">仪表盘</a>
                <a href="/admin/posts.html" class="active">文章管理</a>
                <a href="/admin/users.html">用户管理</a>
                <a href="/admin/comments.html">评论管理</a>
                <a href="/admin/settings.html">站点设置</a>
                <a href="#" id="logoutBtn">退出登录</a>
            </nav>
        </aside>

        <main class="admin-main">
            <div class="admin-header">
                <h1>文章管理</h1>
                <div class="user-info" id="userInfo">
                    <span>加载中...</span>
                </div>
            </div>

            <div class="admin-content">
                <div class="action-bar">
                    <button class="btn btn-primary" onclick="openEditor()">写新文章</button>
                    <div>
                        <span id="selectedCount" style="display: none; margin-right: 10px;">已选择 <span id="countNum">0</span> 篇</span>
                        <button class="btn btn-danger" onclick="batchDelete()" style="display: none;" id="batchDeleteBtn">批量删除</button>
                    </div>
                </div>

                <div class="filters">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="搜索文章标题..." onkeyup="searchPosts()">
                    </div>
                    <select class="filter-select" id="statusFilter" onchange="filterPosts()">
                        <option value="all">全部状态</option>
                        <option value="published">已发布</option>
                        <option value="draft">草稿</option>
                    </select>
                    <select class="filter-select" id="authorFilter" onchange="filterPosts()">
                        <option value="all">所有作者</option>
                    </select>
                    <select class="filter-select" id="sortFilter" onchange="filterPosts()">
                        <option value="newest">最新发布</option>
                        <option value="oldest">最早发布</option>
                        <option value="most-viewed">最多阅读</option>
                        <option value="most-commented">最多评论</option>
                    </select>
                </div>

                <div class="table-container">
                    <table id="postsTable">
                        <thead>
                            <tr>
                                <th width="40"><input type="checkbox" id="selectAll" onchange="toggleAll()"></th>
                                <th>标题</th>
                                <th>作者</th>
                                <th>状态</th>
                                <th>发布日期</th>
                                <th>阅读量</th>
                                <th>评论数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="postsList">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px;">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="pagination" id="pagination"></div>
            </div>
        </main>
    </div>

    <!-- 文章编辑模态框 -->
    <div class="modal" id="editorModal">
        <div class="modal-content editor-modal">
            <div class="modal-header">
                <h2 id="editorTitle">写新文章</h2>
                <span class="modal-close" onclick="closeEditor()">&times;</span>
            </div>
            <form id="postForm">
                <div class="form-group">
                    <label for="postTitle">标题</label>
                    <input type="text" id="postTitle" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>标签</label>
                    <div class="tag-input" id="tagContainer">
                        <div id="tagList"></div>
                        <input type="text" class="tag-input-field" id="tagInput" placeholder="输入标签后按回车" onkeypress="handleTagKeypress(event)">
                    </div>
                </div>

                <div class="form-group">
                    <label>内容</label>
                    <div class="editor-toolbar">
                        <button type="button" onclick="insertFormat('**', '**')">加粗</button>
                        <button type="button" onclick="insertFormat('*', '*')">斜体</button>
                        <button type="button" onclick="insertFormat('# ', '')">标题1</button>
                        <button type="button" onclick="insertFormat('## ', '')">标题2</button>
                        <button type="button" onclick="insertFormat('- ', '')">列表</button>
                        <button type="button" onclick="insertFormat('[', '](url)')">链接</button>
                        <button type="button" onclick="insertFormat('![', '](image-url)')">图片</button>
                        <button type="button" onclick="insertFormat('```\n', '\n```')">代码块</button>
                    </div>
                    <textarea id="postContent" class="editor-content" placeholder="写点什么呢..."></textarea>
                </div>

                <div class="form-group">
                    <label for="featuredImage">特色图片URL</label>
                    <input type="url" id="featuredImage" class="form-control" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label for="postExcerpt">摘要（选填）</label>
                    <textarea id="postExcerpt" class="form-control" rows="3" placeholder="如果不填，将自动从内容生成"></textarea>
                </div>

                <div class="form-group">
                    <button type="button" class="btn btn-primary" onclick="savePost('draft')">保存草稿</button>
                    <button type="button" class="btn btn-primary" onclick="savePost('published')">发布</button>
                    <button type="button" class="btn" onclick="closeEditor()">取消</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let currentUser = null;
        let currentPage = 1;
        let totalPages = 1;
        let selectedPosts = new Set();
        let currentPostId = null;
        let tags = [];

        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (!data.success) {
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                    return;
                }

                currentUser = data.data.user;
                if (currentUser.role === 'user') {
                    window.location.href = '/';
                    return;
                }

                document.getElementById('userInfo').innerHTML = `
                    <img src="${currentUser.avatar || '/avatar.png'}" class="user-avatar" alt="avatar">
                    <span>${currentUser.username} (${currentUser.role === 'super_admin' ? '超级管理员' : '管理员'})</span>
                `;

                loadAuthors();
                loadPosts();
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login';
            }
        }

        async function loadAuthors() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/admin/users?limit=100`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    const authorFilter = document.getElementById('authorFilter');
                    data.data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        authorFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('加载作者列表失败:', error);
            }
        }

        async function loadPosts() {
            const search = document.getElementById('searchInput').value;
            const status = document.getElementById('statusFilter').value;
            const author = document.getElementById('authorFilter').value;
            const sort = document.getElementById('sortFilter').value;
            
            let url = `${API_BASE}/api/admin/posts?page=${currentPage}&limit=10`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (status !== 'all') url += `&status=${status}`;
            if (author !== 'all') url += `&author=${author}`;
            if (sort !== 'newest') url += `&sort=${sort}`;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    renderPosts(data.data.posts);
                    totalPages = data.data.totalPages;
                    renderPagination();
                }
            } catch (error) {
                console.error('加载文章失败:', error);
            }
        }

        function renderPosts(posts) {
            const tbody = document.getElementById('postsList');
            
            if (posts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">暂无文章</td></tr>';
                return;
            }

            tbody.innerHTML = posts.map(post => `
                <tr>
                    <td><input type="checkbox" class="post-checkbox" value="${post.id}" onchange="updateSelection(this)" ${selectedPosts.has(post.id) ? 'checked' : ''}></td>
                    <td class="post-title-cell">
                        <a href="/post.html?id=${post.id}" target="_blank">${post.title}</a>
                        <div class="post-meta">
                            ${post.tags && post.tags.length ? post.tags.map(t => `#${t}`).join(' ') : ''}
                        </div>
                    </td>
                    <td>${post.authorName}</td>
                    <td><span class="status-badge status-${post.status}">${post.status === 'published' ? '已发布' : '草稿'}</span></td>
                    <td>${post.publishedAt ? new Date(post.publishedAt).toLocaleDateString() : '-'}</td>
                    <td>${post.views || 0}</td>
                    <td>${post.commentCount || 0}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="editPost('${post.id}')">编辑</button>
                        <button class="btn btn-sm btn-danger" onclick="deletePost('${post.id}')">删除</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            let html = '';
            
            for (let i = 1; i <= totalPages; i++) {
                html += `<span class="page-item ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</span>`;
            }
            
            pagination.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadPosts();
        }

        function filterPosts() {
            currentPage = 1;
            loadPosts();
        }

        function searchPosts() {
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadPosts();
            }, 500);
        }

        function toggleAll() {
            const checkboxes = document.querySelectorAll('.post-checkbox');
            const selectAll = document.getElementById('selectAll');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedPosts.add(cb.value);
                } else {
                    selectedPosts.delete(cb.value);
                }
            });
            
            updateSelectionUI();
        }

        function updateSelection(checkbox) {
            if (checkbox.checked) {
                selectedPosts.add(checkbox.value);
            } else {
                selectedPosts.delete(checkbox.value);
                document.getElementById('selectAll').checked = false;
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedPosts.size;
            const countSpan = document.getElementById('selectedCount');
            const batchBtn = document.getElementById('batchDeleteBtn');
            
            if (count > 0) {
                countSpan.style.display = 'inline';
                document.getElementById('countNum').textContent = count;
                batchBtn.style.display = 'inline-block';
            } else {
                countSpan.style.display = 'none';
                batchBtn.style.display = 'none';
            }
        }

        async function batchDelete() {
            if (!confirm(`确定要删除选中的 ${selectedPosts.size} 篇文章吗？`)) return;
            
            try {
                const token = localStorage.getItem('token');
                const promises = Array.from(selectedPosts).map(id => 
                    fetch(`${API_BASE}/api/posts/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                );
                
                await Promise.all(promises);
                selectedPosts.clear();
                document.getElementById('selectAll').checked = false;
                updateSelectionUI();
                loadPosts();
            } catch (error) {
                console.error('批量删除失败:', error);
                alert('删除失败，请重试');
            }
        }

        function openEditor() {
            currentPostId = null;
            document.getElementById('editorTitle').textContent = '写新文章';
            document.getElementById('postForm').reset();
            document.getElementById('postContent').value = '';
            tags = [];
            renderTags();
            document.getElementById('editorModal').classList.add('show');
        }

        function closeEditor() {
            document.getElementById('editorModal').classList.remove('show');
        }

        async function editPost(id) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/posts/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    currentPostId = id;
                    document.getElementById('editorTitle').textContent = '编辑文章';
                    document.getElementById('postTitle').value = data.data.title;
                    document.getElementById('postContent').value = data.data.content;
                    document.getElementById('featuredImage').value = data.data.featuredImage || '';
                    document.getElementById('postExcerpt').value = data.data.excerpt || '';
                    tags = data.data.tags || [];
                    renderTags();
                    document.getElementById('editorModal').classList.add('show');
                }
            } catch (error) {
                console.error('加载文章失败:', error);
                alert('加载文章失败');
            }
        }

        async function savePost(status) {
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const featuredImage = document.getElementById('featuredImage').value;
            const excerpt = document.getElementById('postExcerpt').value;

            if (!title) {
                alert('请输入标题');
                return;
            }

            if (!content) {
                alert('请输入内容');
                return;
            }

            const postData = {
                title,
                content,
                tags,
                featuredImage: featuredImage || null,
                excerpt: excerpt || null,
                status
            };

            try {
                const token = localStorage.getItem('token');
                const url = currentPostId 
                    ? `${API_BASE}/api/posts/${currentPostId}`
                    : `${API_BASE}/api/posts`;
                const method = currentPostId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(postData)
                });

                const data = await response.json();
                
                if (data.success) {
                    closeEditor();
                    loadPosts();
                } else {
                    alert(data.error || '保存失败');
                }
            } catch (error) {
                console.error('保存文章失败:', error);
                alert('保存失败，请重试');
            }
        }

        async function deletePost(id) {
            if (!confirm('确定要删除这篇文章吗？')) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/posts/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.success) {
                    loadPosts();
                } else {
                    alert(data.error || '删除失败');
                }
            } catch (error) {
                console.error('删除文章失败:', error);
                alert('删除失败，请重试');
            }
        }

        function insertFormat(before, after) {
            const textarea = document.getElementById('postContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selectedText = text.substring(start, end);
            
            textarea.value = text.substring(0, start) + before + selectedText + after + text.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + before.length, end + before.length);
        }

        function handleTagKeypress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('tagInput');
                const tag = input.value.trim();
                
                if (tag && !tags.includes(tag)) {
                    tags.push(tag);
                    renderTags();
                }
                input.value = '';
            }
        }

        function renderTags() {
            const tagList = document.getElementById('tagList');
            tagList.innerHTML = tags.map(tag => `
                <span class="tag">
                    ${tag}
                    <span class="tag-remove" onclick="removeTag('${tag}')">&times;</span>
                </span>
            `).join('');
        }

        function removeTag(tag) {
            tags = tags.filter(t => t !== tag);
            renderTags();
        }

        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('token');
            
            if (token) {
                await fetch(`${API_BASE}/api/auth/logout`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            }
            
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        });

        checkAuth();
    </script>
</body>
</html>